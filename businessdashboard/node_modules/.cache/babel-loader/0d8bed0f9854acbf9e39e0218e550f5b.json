{"ast":null,"code":"var assert = require('assert');\n\nvar os = require('os');\n\nvar util = require('util');\n\nvar _ = require('lodash');\n\nvar S = require('string');\n\nvar moment = require('moment');\n\nvar Promise = require('bluebird');\n\nvar _constants = require('./constants');\n\nvar _utils = require('./utils');\n\nvar DEFAULT_PAGE = 0,\n    DEFAULT_PAGE_SIZE = 10;\n\nfunction _sanitizeCompanyNews(options) {\n  assert(_.isPlainObject(options), '\"options\" must be a plain object.');\n  assert(!_.isUndefined(options.symbol) || !_.isUndefined(options.symbols), 'Either \"options.symbol\" or \"options.symbols\" must be defined.');\n  assert(_.isUndefined(options.symbol) || _.isUndefined(options.symbols), 'Either \"options.symbol\" or \"options.symbols\" must be undefined.');\n  assert(_.isUndefined(options.error) || _.isBoolean(options.error), '\"options.error\" must be a boolean value');\n\n  if (!_.isUndefined(options.symbol)) {\n    assert(_.isString(options.symbol) && !_.isEmpty(options.symbol), '\"options.symbol\" must be a non-empty string.');\n  } else {\n    assert(_.isArray(options.symbols) && !_.isEmpty(options.symbols), '\"options.symbols\" must be a non-empty string array.');\n  }\n}\n\nfunction _sanitizeHistorical(options) {\n  assert(_.isPlainObject(options), '\"options\" must be a plain object.');\n  assert(!_.isUndefined(options.symbol) || !_.isUndefined(options.symbols), 'Either \"options.symbol\" or \"options.symbols\" must be defined.');\n  assert(_.isUndefined(options.symbol) || _.isUndefined(options.symbols), 'Either \"options.symbol\" or \"options.symbols\" must be undefined.');\n  assert(_.isUndefined(options.error) || _.isBoolean(options.error), '\"options.error\" must be a boolean value');\n\n  if (!_.isUndefined(options.symbol)) {\n    assert(_.isString(options.symbol) && !_.isEmpty(options.symbol), '\"options.symbol\" must be a non-empty string.');\n  } else {\n    assert(_.isArray(options.symbols) && !_.isEmpty(options.symbols), '\"options.symbols\" must be a non-empty string array.');\n  }\n\n  if (_.isString(options.from) && !_.isEmpty(options.from)) {\n    options.from = moment(options.from);\n    assert(options.from.isValid(), '\"options.from\" must be a valid date string.');\n  } else {\n    assert(_.isDate(options.from) || _.isUndefined(options.from) || _.isNull(options.from), '\"options.from\" must be a date or undefined/null.');\n\n    if (_.isDate(options.from)) {\n      options.from = moment(options.from);\n    }\n  }\n\n  if (_.isString(options.to) && !_.isEmpty(options.to)) {\n    options.to = moment(options.to);\n    assert(options.to.isValid(), '\"options.to\" must be a valid date string.');\n  } else {\n    assert(_.isDate(options.to) || _.isUndefined(options.to) || _.isNull(options.to), '\"options.to\" must be a date or undefined/null.');\n\n    if (_.isDate(options.to)) {\n      options.to = moment(options.to);\n    }\n  }\n\n  if (!options.from || options.from.isBefore('1970-01-01')) {\n    options.from = moment('1970-01-01');\n  }\n\n  if (!options.to) {\n    options.to = moment({\n      hour: 0\n    });\n  }\n\n  assert(!options.from && !options.to || !options.from.isAfter(options.to), '\"options.to\" must be be greater than or equal to \"options.from\".');\n}\n\nfunction _transformCompanyNews(symbol, data) {\n  return _(data).sortBy(function (item) {\n    return item.date;\n  }).map(function (item) {\n    return {\n      guid: item.guid,\n      symbol: symbol,\n      title: S(item.title).stripTags().trim().decodeHTMLEntities().s,\n      description: S(item.description).stripTags().trim().decodeHTMLEntities().s,\n      summary: S(item.summary).stripTags().trim().decodeHTMLEntities().s,\n      date: item.date,\n      link: item.link\n    };\n  }).value();\n}\n\nfunction _transformHistorical(symbol, data) {\n  var headings = data.shift();\n  return _(data).reverse().map(function (line) {\n    var result = {};\n    headings.forEach(function (heading, i) {\n      var value = line[i];\n\n      if (_.includes(['Volume'], heading)) {\n        value = _utils.toInt(value, null);\n      } else if (_.includes(['Open', 'High', 'Low', 'Close'], heading)) {\n        value = _utils.toFloat(value, null);\n      } else if (_.includes(['Date'], heading)) {\n        value = _utils.toDate(value, null);\n\n        if (value && !moment(value).isValid()) {\n          value = null;\n        }\n      }\n\n      result[_utils.camelize(heading)] = value;\n    });\n    result.symbol = symbol;\n    return result;\n  }).value();\n}\n\nfunction companyNews(options, optionalHttpRequestOptions, cb) {\n  if (_.isUndefined(options)) {\n    options = {};\n  }\n\n  _sanitizeCompanyNews(options);\n\n  if (optionalHttpRequestOptions && typeof optionalHttpRequestOptions == 'function') {\n    cb = optionalHttpRequestOptions;\n    optionalHttpRequestOptions = undefined;\n  }\n\n  var symbols = options.symbols || _.flatten([options.symbol]);\n\n  return Promise.resolve(symbols).map(function (symbol) {\n    return Promise.resolve().then(function () {\n      var params = {\n        output: 'rss',\n        q: symbol,\n        num: DEFAULT_PAGE_SIZE,\n        start: DEFAULT_PAGE\n      };\n      if (!isNaN(options.page_size)) params.num = options.page_size;\n      if (!isNaN(options.page)) params.start = (options.page - 1) * params.num;\n      return _utils.downloadRSS(_constants.COMPANY_NEWS_URL, params, optionalHttpRequestOptions);\n    }).then(function (data) {\n      return _transformCompanyNews(symbol, data);\n    }).catch(function (err) {\n      if (options.error) {\n        throw err;\n      } else {\n        return [];\n      }\n    });\n  }, {\n    concurrency: os.cpus().length\n  }).then(function (results) {\n    if (options.symbols) {\n      return _.zipObject(symbols, results);\n    } else {\n      return results[0];\n    }\n  }).catch(function (err) {\n    throw new Error(util.format('Failed to download data (%s)', err.message));\n  }).nodeify(cb);\n}\n\nfunction historical(options, optionalHttpRequestOptions, cb) {\n  if (_.isUndefined(options)) {\n    options = {};\n  }\n\n  _sanitizeHistorical(options);\n\n  if (optionalHttpRequestOptions && typeof optionalHttpRequestOptions == 'function') {\n    cb = optionalHttpRequestOptions;\n    optionalHttpRequestOptions = undefined;\n  }\n\n  var symbols = options.symbols || _.flatten([options.symbol]);\n\n  return Promise.resolve(symbols).map(function (symbol) {\n    return Promise.resolve(_utils.getDateRanges(options.from, options.to)).map(function (range) {\n      return Promise.resolve().then(function () {\n        return _utils.download(_constants.HISTORICAL_URL, {\n          q: symbol,\n          startdate: range.from.format('YYYY-MM-DD'),\n          enddate: range.to.format('YYYY-MM-DD'),\n          output: 'csv'\n        }, optionalHttpRequestOptions);\n      }).then(_utils.parseCSV).then(function (data) {\n        return _transformHistorical(symbol, data);\n      }).catch(function (err) {\n        if (options.error) {\n          throw err;\n        } else {\n          return [];\n        }\n      });\n    }).then(_.flatten);\n  }, {\n    concurrency: os.cpus().length\n  }).then(function (results) {\n    if (options.symbols) {\n      return _.zipObject(symbols, results);\n    } else {\n      return results[0];\n    }\n  }).catch(function (err) {\n    throw new Error(util.format('Failed to download data (%s)', err.message));\n  }).nodeify(cb);\n}\n\nexports.companyNews = companyNews;\nexports.historical = historical;","map":{"version":3,"sources":["/home/jlavan1/classProject/BusinessDashboard-/businessdashboard/node_modules/google-finance/lib/index.js"],"names":["assert","require","os","util","_","S","moment","Promise","_constants","_utils","DEFAULT_PAGE","DEFAULT_PAGE_SIZE","_sanitizeCompanyNews","options","isPlainObject","isUndefined","symbol","symbols","error","isBoolean","isString","isEmpty","isArray","_sanitizeHistorical","from","isValid","isDate","isNull","to","isBefore","hour","isAfter","_transformCompanyNews","data","sortBy","item","date","map","guid","title","stripTags","trim","decodeHTMLEntities","s","description","summary","link","value","_transformHistorical","headings","shift","reverse","line","result","forEach","heading","i","includes","toInt","toFloat","toDate","camelize","companyNews","optionalHttpRequestOptions","cb","undefined","flatten","resolve","then","params","output","q","num","start","isNaN","page_size","page","downloadRSS","COMPANY_NEWS_URL","catch","err","concurrency","cpus","length","results","zipObject","Error","format","message","nodeify","historical","getDateRanges","range","download","HISTORICAL_URL","startdate","enddate","parseCSV","exports"],"mappings":"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","sourcesContent":["var assert = require('assert');\nvar os = require('os');\nvar util = require('util');\n\nvar _ = require('lodash');\nvar S = require('string');\nvar moment = require('moment');\nvar Promise = require('bluebird');\n\nvar _constants = require('./constants');\nvar _utils = require('./utils');\n\nvar DEFAULT_PAGE      = 0,\n    DEFAULT_PAGE_SIZE = 10;\n\nfunction _sanitizeCompanyNews(options) {\n  assert(_.isPlainObject(options),\n         '\"options\" must be a plain object.');\n  assert(!_.isUndefined(options.symbol) || !_.isUndefined(options.symbols),\n         'Either \"options.symbol\" or \"options.symbols\" must be defined.');\n  assert(_.isUndefined(options.symbol) || _.isUndefined(options.symbols),\n         'Either \"options.symbol\" or \"options.symbols\" must be undefined.');\n  assert(_.isUndefined(options.error) || _.isBoolean(options.error),\n         '\"options.error\" must be a boolean value');\n\n  if (!_.isUndefined(options.symbol)) {\n    assert((_.isString(options.symbol) && !_.isEmpty(options.symbol)),\n           '\"options.symbol\" must be a non-empty string.');\n  } else {\n    assert((_.isArray(options.symbols) && !_.isEmpty(options.symbols)),\n           '\"options.symbols\" must be a non-empty string array.');\n  }\n}\n\nfunction _sanitizeHistorical(options) {\n  assert(_.isPlainObject(options),\n         '\"options\" must be a plain object.');\n  assert(!_.isUndefined(options.symbol) || !_.isUndefined(options.symbols),\n         'Either \"options.symbol\" or \"options.symbols\" must be defined.');\n  assert(_.isUndefined(options.symbol) || _.isUndefined(options.symbols),\n         'Either \"options.symbol\" or \"options.symbols\" must be undefined.');\n  assert(_.isUndefined(options.error) || _.isBoolean(options.error),\n         '\"options.error\" must be a boolean value');\n\n  if (!_.isUndefined(options.symbol)) {\n    assert((_.isString(options.symbol) && !_.isEmpty(options.symbol)),\n           '\"options.symbol\" must be a non-empty string.');\n  } else {\n    assert((_.isArray(options.symbols) && !_.isEmpty(options.symbols)),\n           '\"options.symbols\" must be a non-empty string array.');\n  }\n\n  if (_.isString(options.from) && !_.isEmpty(options.from)) {\n    options.from = moment(options.from);\n    assert(options.from.isValid(), '\"options.from\" must be a valid date string.');\n  } else {\n    assert(_.isDate(options.from) || _.isUndefined(options.from) || _.isNull(options.from),\n           '\"options.from\" must be a date or undefined/null.');\n    if (_.isDate(options.from)) {\n      options.from = moment(options.from);\n    }\n  }\n\n  if (_.isString(options.to) && !_.isEmpty(options.to)) {\n    options.to = moment(options.to);\n    assert(options.to.isValid(), '\"options.to\" must be a valid date string.');\n  } else {\n    assert(_.isDate(options.to) || _.isUndefined(options.to) || _.isNull(options.to),\n           '\"options.to\" must be a date or undefined/null.');\n    if (_.isDate(options.to)) {\n      options.to = moment(options.to);\n    }\n  }\n\n  if (!options.from || options.from.isBefore('1970-01-01')) {\n    options.from = moment('1970-01-01');\n  }\n\n  if (!options.to) {\n    options.to = moment({ hour: 0 });\n  }\n\n  assert((!options.from && !options.to) || !options.from.isAfter(options.to),\n         '\"options.to\" must be be greater than or equal to \"options.from\".');\n}\n\nfunction _transformCompanyNews(symbol, data) {\n  return _(data)\n    .sortBy(function (item) {\n      return item.date;\n    })\n    .map(function (item) {\n      return {\n        guid: item.guid,\n        symbol: symbol,\n        title: S(item.title).stripTags().trim().decodeHTMLEntities().s,\n        description: S(item.description).stripTags().trim().decodeHTMLEntities().s,\n        summary: S(item.summary).stripTags().trim().decodeHTMLEntities().s,\n        date: item.date,\n        link: item.link\n      };\n    })\n    .value();\n}\n\nfunction _transformHistorical(symbol, data) {\n  var headings = data.shift();\n  return _(data)\n    .reverse()\n    .map(function (line) {\n      var result = {};\n      headings.forEach(function (heading, i) {\n        var value = line[i];\n        if (_.includes(['Volume'], heading)) {\n          value = _utils.toInt(value, null);\n        } else if (_.includes(['Open', 'High', 'Low', 'Close'], heading)) {\n          value = _utils.toFloat(value, null);\n        } else if (_.includes(['Date'], heading)) {\n          value = _utils.toDate(value, null);\n          if (value && !moment(value).isValid()) {\n            value = null;\n          }\n        }\n        result[_utils.camelize(heading)] = value;\n      });\n      result.symbol = symbol;\n      return result;\n    })\n    .value();\n}\n\nfunction companyNews(options, optionalHttpRequestOptions, cb) {\n  if (_.isUndefined(options)) { options = {}; }\n  _sanitizeCompanyNews(options);\n\n  if(optionalHttpRequestOptions && typeof optionalHttpRequestOptions == 'function') {\n    cb = optionalHttpRequestOptions;\n    optionalHttpRequestOptions = undefined;\n  }\n\n  var symbols = options.symbols || _.flatten([options.symbol]);\n\n  return Promise.resolve(symbols)\n    .map(function (symbol) {\n      return Promise.resolve()\n        .then(function () {\n\n          var params = { output: 'rss', q: symbol, num: DEFAULT_PAGE_SIZE, start: DEFAULT_PAGE };\n\n          if(!isNaN(options.page_size)) params.num = options.page_size;\n          if(!isNaN(options.page)) params.start = (options.page - 1) * params.num;\n\n          return _utils.downloadRSS(_constants.COMPANY_NEWS_URL, params, optionalHttpRequestOptions);\n        })\n        .then(function (data) {\n          return _transformCompanyNews(symbol, data);\n        })\n        .catch(function (err) {\n          if (options.error) {\n            throw err;\n          } else {\n            return [];\n          }\n        });\n    }, {concurrency: os.cpus().length})\n    .then(function (results) {\n      if (options.symbols) {\n        return _.zipObject(symbols, results);\n      } else {\n        return results[0];\n      }\n    })\n    .catch(function (err) {\n      throw new Error(util.format('Failed to download data (%s)', err.message));\n    })\n    .nodeify(cb);\n}\n\nfunction historical(options, optionalHttpRequestOptions, cb) {\n  if (_.isUndefined(options)) { options = {}; }\n  _sanitizeHistorical(options);\n\n  if(optionalHttpRequestOptions && typeof optionalHttpRequestOptions == 'function') {\n    cb = optionalHttpRequestOptions;\n    optionalHttpRequestOptions = undefined;\n  }\n\n  var symbols = options.symbols || _.flatten([options.symbol]);\n\n  return Promise.resolve(symbols)\n    .map(function (symbol) {\n      return Promise.resolve(_utils.getDateRanges(options.from, options.to))\n        .map(function (range) {\n          return Promise.resolve()\n            .then(function () {\n              return _utils.download(_constants.HISTORICAL_URL, {\n                q: symbol,\n                startdate: range.from.format('YYYY-MM-DD'),\n                enddate: range.to.format('YYYY-MM-DD'),\n                output: 'csv'\n              }, optionalHttpRequestOptions);\n            })\n            .then(_utils.parseCSV)\n            .then(function (data) {\n              return _transformHistorical(symbol, data);\n            })\n            .catch(function (err) {\n              if (options.error) {\n                throw err;\n              } else {\n                return [];\n              }\n            });\n        })\n        .then(_.flatten);\n    }, {concurrency: os.cpus().length})\n    .then(function (results) {\n      if (options.symbols) {\n        return _.zipObject(symbols, results);\n      } else {\n        return results[0];\n      }\n    })\n    .catch(function (err) {\n      throw new Error(util.format('Failed to download data (%s)', err.message));\n    })\n    .nodeify(cb);\n}\n\nexports.companyNews = companyNews;\nexports.historical = historical;\n"]},"metadata":{},"sourceType":"script"}